<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAT Model: EMA Update Mechanism Visualization</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 50px;
        }
        
        .section h2 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 30px;
            font-size: 1.8em;
        }
        
        .comparison-container {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .scenario {
            flex: 1;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            padding: 25px;
            background: #f8f9fa;
        }
        
        .scenario.with-ema {
            border-color: #27ae60;
            background: linear-gradient(135deg, #d5f4e6 0%, #a8e6cf 100%);
        }
        
        .scenario.without-ema {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #fadbd8 0%, #f1948a 100%);
        }
        
        .scenario h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.4em;
        }
        
        .architecture-diagram {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .model-box {
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #ecf0f1;
            text-align: center;
            font-weight: bold;
            position: relative;
        }
        
        .student-model {
            border-color: #e67e22;
            background: #f39c12;
            color: white;
        }
        
        .teacher-model {
            border-color: #8e44ad;
            background: #9b59b6;
            color: white;
        }
        
        .ema-update {
            border-color: #27ae60;
            background: #2ecc71;
            color: white;
        }
        
        .arrow {
            text-align: center;
            font-size: 2em;
            color: #3498db;
            margin: 10px 0;
        }
        
        .update-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .update-step {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin: 0 5px;
        }
        
        .step-1 { background: #e8f4fd; border-left: 4px solid #3498db; }
        .step-2 { background: #f0f9ff; border-left: 4px solid #2980b9; }
        .step-3 { background: #e8f8f5; border-left: 4px solid #27ae60; }
        .step-4 { background: #fef9e7; border-left: 4px solid #f39c12; }
        
        .formula {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
            text-align: center;
            font-size: 1.1em;
        }
        
        .parameters {
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 20px;
            margin: 20px 0;
        }
        
        .parameter-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .parameter-item:last-child {
            border-bottom: none;
        }
        
        .parameter-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .parameter-value {
            color: #6c757d;
            font-family: 'Courier New', monospace;
        }
        
        .timeline {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .timeline-step {
            background: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .timeline-desc {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .benefits {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin: 30px 0;
        }
        
        .benefits h3 {
            margin-top: 0;
            font-size: 1.5em;
        }
        
        .benefit-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }
        
        .benefit-icon {
            background: rgba(255,255,255,0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.2em;
        }
        
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .highlight {
            background: #f39c12;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .decay-curve {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .curve-container {
            width: 100%;
            height: 300px;
            background: #f8f9fa;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .curve-svg {
            width: 100%;
            height: 100%;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
        }
        
        .legend-color {
            width: 20px;
            height: 3px;
            margin-right: 8px;
        }
        
        .initial-decay { background: #e74c3c; }
        .final-decay { background: #27ae60; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EAT Model: EMA Update Mechanism</h1>
            <p>Exponential Moving Average in Teacher-Student Architecture</p>
        </div>
        
        <div class="content">
            <!-- Overview Section -->
            <div class="section">
                <h2>üìä Overview</h2>
                <p>The EAT (Efficient Audio Transformer) model uses an Exponential Moving Average (EMA) mechanism to create a stable teacher model that guides the student model during self-supervised pre-training. This approach helps stabilize training and improve representation learning.</p>
                
                <div class="comparison-container">
                    <div class="scenario with-ema">
                        <h3>‚úÖ With EMA</h3>
                        <ul>
                            <li><strong>Stable Training:</strong> Teacher model updates smoothly</li>
                            <li><strong>Better Convergence:</strong> Reduces training instability</li>
                            <li><strong>Consistent Targets:</strong> Provides stable learning targets</li>
                            <li><strong>Memory Efficient:</strong> Only updates teacher parameters</li>
                        </ul>
                    </div>
                    
                    <div class="scenario without-ema">
                        <h3>‚ùå Without EMA</h3>
                        <ul>
                            <li><strong>Unstable Training:</strong> Teacher changes rapidly</li>
                            <li><strong>Poor Convergence:</strong> May oscillate or diverge</li>
                            <li><strong>Inconsistent Targets:</strong> Moving target problem</li>
                            <li><strong>Computational Cost:</strong> Full model updates</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Architecture Section -->
            <div class="section">
                <h2>üèóÔ∏è Architecture Comparison</h2>
                
                <div class="architecture-diagram">
                    <h3>With EMA (EAT Implementation)</h3>
                    <div class="model-box student-model">Student Model<br/>CNN Encoder + Transformer</div>
                    <div class="arrow">‚Üì</div>
                    <div class="model-box ema-update">EMA Update<br/>Œ∏_teacher = Œ±¬∑Œ∏_teacher + (1-Œ±)¬∑Œ∏_student</div>
                    <div class="arrow">‚Üì</div>
                    <div class="model-box teacher-model">Teacher Model<br/>Frozen CNN + EMA Transformer</div>
                    <div class="arrow">‚Üì</div>
                    <div class="model-box" style="background: #e8f4fd; border-color: #3498db;">Target Features<br/>Averaged from 12 layers</div>
                </div>
                
                <div class="architecture-diagram">
                    <h3>Without EMA (Standard Approach)</h3>
                    <div class="model-box student-model">Student Model<br/>CNN Encoder + Transformer</div>
                    <div class="arrow">‚Üì</div>
                    <div class="model-box" style="background: #fadbd8; border-color: #e74c3c;">Direct Copy<br/>Œ∏_teacher = Œ∏_student</div>
                    <div class="arrow">‚Üì</div>
                    <div class="model-box teacher-model">Teacher Model<br/>Identical to Student</div>
                    <div class="arrow">‚Üì</div>
                    <div class="model-box" style="background: #fadbd8; border-color: #e74c3c;">Target Features<br/>Current student features</div>
                </div>
            </div>
            
            <!-- EMA Update Process -->
            <div class="section">
                <h2>üîÑ EMA Update Process</h2>
                
                <div class="update-flow">
                    <div class="update-step step-1">
                        <strong>Step 1:</strong><br/>
                        Student Forward Pass
                    </div>
                    <div class="update-step step-2">
                        <strong>Step 2:</strong><br/>
                        Teacher Forward Pass
                    </div>
                    <div class="update-step step-3">
                        <strong>Step 3:</strong><br/>
                        Compute Loss
                    </div>
                    <div class="update-step step-4">
                        <strong>Step 4:</strong><br/>
                        Update Student & Teacher
                    </div>
                </div>
                
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-step">1</div>
                        <div class="timeline-content">
                            <div class="timeline-title">Student Model Processing</div>
                            <div class="timeline-desc">Audio spectrogram ‚Üí CNN encoder ‚Üí Masked Transformer ‚Üí Predictions</div>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-step">2</div>
                        <div class="timeline-content">
                            <div class="timeline-title">Teacher Model Processing</div>
                            <div class="timeline-desc">Same audio ‚Üí CNN encoder ‚Üí Unmasked Transformer ‚Üí Target features</div>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-step">3</div>
                        <div class="timeline-content">
                            <div class="timeline-title">Loss Computation</div>
                            <div class="timeline-desc">MSE loss between student predictions and teacher targets (masked positions only)</div>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-step">4</div>
                        <div class="timeline-content">
                            <div class="timeline-title">Parameter Updates</div>
                            <div class="timeline-desc">Student: Gradient descent | Teacher: EMA update Œ∏_t = Œ±¬∑Œ∏_t + (1-Œ±)¬∑Œ∏_s</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mathematical Formula -->
            <div class="section">
                <h2>üßÆ Mathematical Foundation</h2>
                
                <div class="formula">
                    <strong>EMA Update Formula:</strong><br/>
                    Œ∏_teacher^(t+1) = Œ± ¬∑ Œ∏_teacher^(t) + (1-Œ±) ¬∑ Œ∏_student^(t+1)
                </div>
                
                <div class="parameters">
                    <h3>Key Parameters in EAT:</h3>
                    <div class="parameter-item">
                        <span class="parameter-name">Initial EMA Decay (Œ±):</span>
                        <span class="parameter-value">0.999</span>
                    </div>
                    <div class="parameter-item">
                        <span class="parameter-name">Final EMA Decay (Œ±):</span>
                        <span class="parameter-value">0.9999</span>
                    </div>
                    <div class="parameter-item">
                        <span class="parameter-name">Annealing Steps:</span>
                        <span class="parameter-value">max_update (300,000)</span>
                    </div>
                    <div class="parameter-item">
                        <span class="parameter-name">EMA Encoder Only:</span>
                        <span class="parameter-value">True</span>
                    </div>
                    <div class="parameter-item">
                        <span class="parameter-name">Average Top-K Layers:</span>
                        <span class="parameter-value">12 (all layers)</span>
                    </div>
                </div>
            </div>
            
            <!-- Decay Curve Visualization -->
            <div class="section">
                <h2>üìà EMA Decay Schedule</h2>
                
                <div class="decay-curve">
                    <h3>Decay Rate Over Training Steps</h3>
                    <div class="curve-container">
                        <svg class="curve-svg" viewBox="0 0 800 300">
                            <!-- Grid lines -->
                            <defs>
                                <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
                                    <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#e0e0e0" stroke-width="1"/>
                                </pattern>
                            </defs>
                            <rect width="100%" height="100%" fill="url(#grid)"/>
                            
                            <!-- X-axis -->
                            <line x1="50" y1="250" x2="750" y2="250" stroke="#333" stroke-width="2"/>
                            <text x="400" y="290" text-anchor="middle" font-size="14" fill="#333">Training Steps</text>
                            
                            <!-- Y-axis -->
                            <line x1="50" y1="50" x2="50" y2="250" stroke="#333" stroke-width="2"/>
                            <text x="20" y="150" text-anchor="middle" font-size="14" fill="#333" transform="rotate(-90, 20, 150)">EMA Decay Rate</text>
                            
                            <!-- Initial decay curve (0.999) -->
                            <path d="M 50,50 Q 200,100 400,150 T 750,200" stroke="#e74c3c" stroke-width="3" fill="none"/>
                            
                            <!-- Final decay curve (0.9999) -->
                            <path d="M 50,30 Q 200,80 400,130 T 750,180" stroke="#27ae60" stroke-width="3" fill="none"/>
                            
                            <!-- Labels -->
                            <text x="50" y="45" font-size="12" fill="#e74c3c">0.999</text>
                            <text x="50" y="25" font-size="12" fill="#27ae60">0.9999</text>
                            <text x="100" y="265" font-size="12" fill="#333">0</text>
                            <text x="400" y="265" font-size="12" fill="#333">150k</text>
                            <text x="700" y="265" font-size="12" fill="#333">300k</text>
                        </svg>
                    </div>
                    
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color initial-decay"></div>
                            <span>Initial Decay (0.999)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color final-decay"></div>
                            <span>Final Decay (0.9999)</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Code Implementation -->
            <div class="section">
                <h2>üíª Code Implementation</h2>
                
                <div class="code-block">
<span class="highlight"># EMA Update in set_num_updates method</span>
def set_num_updates(self, num_updates):
    super().set_num_updates(num_updates)
    
    if self.ema is not None and (
        (self.num_updates == 0 and num_updates > 1)
        or self.num_updates >= num_updates
    ):
        pass
    elif self.training and self.ema is not None:
        ema_weight_decay = None
        if self.cfg.ema_decay != self.cfg.ema_end_decay:
            if num_updates >= self.cfg.ema_anneal_end_step:
                decay = self.cfg.ema_end_decay  <span class="highlight"># 0.9999</span>
            else:
                decay = get_annealed_rate(
                    self.cfg.ema_decay,        <span class="highlight"># 0.999</span>
                    self.cfg.ema_end_decay,    <span class="highlight"># 0.9999</span>
                    num_updates,
                    self.cfg.ema_anneal_end_step,
                )
            self.ema.set_decay(decay, weight_decay=ema_weight_decay)
        if self.ema.get_decay() < 1:
            self.ema.step(self.blocks if self.cfg.ema_encoder_only else self)
    
    self.num_updates = num_updates
                </div>
                
                <div class="code-block">
<span class="highlight"># Teacher model creation</span>
def make_ema_teacher(self, ema_decay):
    ema_config = EMAModuleConfig(
        ema_decay=ema_decay,      <span class="highlight"># 0.999</span>
        ema_fp32=True,
        log_norms=self.cfg.log_norms,
        add_missing_params=False,
    )
    
    model_copy = self.make_target_model()
    
    return EMAModule(
        model_copy,
        ema_config,
        copy_model=False,
    )
                </div>
            </div>
            
            <!-- Benefits Section -->
            <div class="benefits">
                <h3>üéØ Benefits of EMA in EAT</h3>
                
                <div class="benefit-item">
                    <div class="benefit-icon">üöÄ</div>
                    <div>
                        <strong>Training Stability:</strong> EMA provides smooth, stable updates to the teacher model, preventing training instability that can occur with direct copying.
                    </div>
                </div>
                
                <div class="benefit-item">
                    <div class="benefit-icon">üéØ</div>
                    <div>
                        <strong>Better Convergence:</strong> The gradual update mechanism helps the model converge to better local minima by maintaining consistent learning targets.
                    </div>
                </div>
                
                <div class="benefit-item">
                    <div class="benefit-icon">‚ö°</div>
                    <div>
                        <strong>Computational Efficiency:</strong> Only the transformer encoder is updated via EMA (ema_encoder_only=True), reducing computational overhead.
                    </div>
                </div>
                
                <div class="benefit-item">
                    <div class="benefit-icon">üîß</div>
                    <div>
                        <strong>Adaptive Decay:</strong> The decay rate increases from 0.999 to 0.9999 over training, providing more stability in later stages.
                    </div>
                </div>
                
                <div class="benefit-item">
                    <div class="benefit-icon">üìä</div>
                    <div>
                        <strong>Consistent Targets:</strong> Teacher model provides stable, high-quality targets for the student model to learn from.
                    </div>
                </div>
            </div>
            
            <!-- Key Differences Summary -->
            <div class="section">
                <h2>üìã Key Differences Summary</h2>
                
                <div class="comparison-container">
                    <div class="scenario with-ema">
                        <h3>With EMA (EAT)</h3>
                        <ul>
                            <li><strong>Teacher Update:</strong> Œ∏_t = Œ±¬∑Œ∏_t + (1-Œ±)¬∑Œ∏_s</li>
                            <li><strong>Stability:</strong> High - smooth updates</li>
                            <li><strong>Convergence:</strong> Better - consistent targets</li>
                            <li><strong>Memory:</strong> Efficient - only encoder updates</li>
                            <li><strong>Training:</strong> More stable, better results</li>
                        </ul>
                    </div>
                    
                    <div class="scenario without-ema">
                        <h3>Without EMA</h3>
                        <ul>
                            <li><strong>Teacher Update:</strong> Œ∏_t = Œ∏_s (direct copy)</li>
                            <li><strong>Stability:</strong> Low - abrupt changes</li>
                            <li><strong>Convergence:</strong> Poor - moving targets</li>
                            <li><strong>Memory:</strong> Inefficient - full model copy</li>
                            <li><strong>Training:</strong> Unstable, may diverge</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
